<!DOCTYPE html PUBLIC "-//WAPFORUM//DTD XHTML Mobile 1.0//EN" "http://www.wapforum.org/DTD/xhtml-mobile10.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <title>Icon Forth</title>
</head>
<body>

<canvas id="iconeditor" width="300" height="257" border="0" style="cursor: crosshair;"></canvas>
<form name="frm" action="/write" method="post">
  <textarea name="description" cols="25" rows="8"></textarea>
  <input name="g" type="submit" value="Add"><br>
  <div id="deficons"><img width="1" height="32"></div>
  <input name="definition" type="hidden">
  <input name="icon" type="hidden">
</form>

<script type="text/javascript">

var drawing = 0;
var palette_color = 2;
var cv = document.getElementById("iconeditor");
var ctx = cv.getContext("2d");
var grid = new Array();
var form_dirty = 0;
var colors = [
  '#ffffff',
  '#c0c0c0',
  '#000000',
  '#ff0000',
  '#ffc000',
  '#ffff00',
  '#00ff00',
  '#00ffff',
  '#0000ff',
  '#ff00ff',
];

function update_icon() {
  // only do things when dirty
  if (!form_dirty) return;
  form_dirty = 0;

  // update image
  var str = "";
  for (var y = 0; y < 16; y++) {
    for (var x = 0; x < 16; x++) {
      str += "" + grid[x+y*16];
    }
  }
  document.frm.icon.value = str;
}

function update_definition() {
  // update definition
  var d = document.getElementById("deficons");
  var str = "";
  for (var i = 1; i < d.childNodes.length; i++) {
    if (str.length) { str += " "; }
    str += d.childNodes.item(i).alt
  }
  document.frm.definition.value = str;
}

function plot(x, y, color) {
  if (x < 0 || x > 15 || y < 0 || y > 15) return;
  if (grid[x+y*16] == color) return;
  form_dirty = 1;

  grid[x+y*16] = color;

  ctx.fillStyle = colors[color];

  ctx.beginPath();
  ctx.rect(x*16+1, y*16+1, 15, 15);
  ctx.closePath();
  ctx.fill();

  ctx.beginPath();
  ctx.rect(262+x*2, 6+y*2, 2, 2);
  ctx.closePath();
  ctx.fill();
}

function blank() {
  ctx.clearRect(0, 0, 300, 257);

  ctx.fillStyle = "#777777";
  ctx.beginPath();
  ctx.rect(0, 0, 300, 257);
  ctx.closePath();
  ctx.fill();

  for(var z = 0; z < 16 * 16; z++) {
    grid[z] = -1;
  }

  for (var x = 0; x < 16; x++) {
    for (var y = 0; y < 16; y++) {
      plot(x, y, 0);
    }
  }
}

function draw_palette() {
  for (var i = 0; i < colors.length; i++) {
    ctx.fillStyle = colors[i];
    ctx.beginPath();
    ctx.rect(262, i * 16 + (32 + 6*2), 32, 16);
    ctx.closePath();
    ctx.fill();
  }
  // Mark selection
  ctx.lineWidth = 2;
  ctx.strokeStyle = "#000000";
  ctx.beginPath();
  ctx.arc(262 + 16 + 0.5, palette_color * 16 + (32 + 6*2) + 8 + 0.5,
          6, 0, Math.PI * 2, true);
  ctx.arc(262 + 16 + 0.5, palette_color * 16 + (32 + 6*2) + 8 + 0.5,
          6, 0, Math.PI * 2, true);
  ctx.closePath();
  ctx.stroke();
  ctx.strokeStyle = "#ffffff";
  ctx.beginPath();
  ctx.arc(262 + 16 - 0.5, palette_color * 16 + (32 + 6*2) + 8 - 0.5,
          6, 0, Math.PI * 2, true);
  ctx.arc(262 + 16 - 0.5, palette_color * 16 + (32 + 6*2) + 8 - 0.5,
          6, 0, Math.PI * 2, true);
  ctx.closePath();
  ctx.stroke();
}

function mousedown(evt) {
  var x = evt.clientX - cv.offsetLeft;
  var y = evt.clientY - cv.offsetTop;

  if (x < 256) {
    x = Math.floor(x / 16);
    y = Math.floor(y / 16);
    plot(x, y, palette_color);
    drawing = 1;
  } else {
    y = Math.floor((y - (32 + 6*2)) / 16);
    if (y >= 0 && y < 10) {
      palette_color = y;
      draw_palette();
    }
  }
}

function mouseup(evt) {
  drawing = 0;
  update_icon();
}

function mousemove(evt) {
  if (drawing) {
    var x = Math.floor((evt.clientX - cv.offsetLeft) / 16);
    var y = Math.floor((evt.clientY - cv.offsetTop) / 16);
    plot(x, y, palette_color);
  }
}

function drop(e) {
  var d = document.getElementById("deficons");
  d.removeChild(e);
  update_definition();
}

function pick(id) {
  var d = document.getElementById("deficons");
  var im = document.createElement("img");
  im.setAttribute("src", "/icon/" + id + ".png");
  im.setAttribute("alt", id);
  im.setAttribute("width", "32");
  im.setAttribute("height", "32");
  im.setAttribute("style", "cursor: pointer;");
  im.setAttribute("onclick", "drop(this)");
  d.appendChild(im);
  update_definition();
}

function init() {
  blank();
  draw_palette(0);
  cv.onmousedown = mousedown;
  cv.onmouseup = mouseup;
  cv.onmousemove = mousemove;
  cv.addEventListener('touchstart', function(event) {
      event.preventDefault();
      mousedown(event.touches[0]);
  }, false);
  cv.addEventListener('touchend', function(event) {
      event.preventDefault();
      mouseup(event.touches[0]);
  }, false);
  cv.addEventListener('touchmove', function(event) {
      event.preventDefault();
      mousemove(event.touches[0]);
  }, false);
}

init();

</script>

</body>
</html>
